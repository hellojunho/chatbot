# 8장. 챗봇 엔진 만들기

## 8.1 챗봇 엔진이란
`챗봇`이란 *채팅 하는 봇*이라는 뜻이다.  
그러면 `챗봇 엔진`이란 뭘까?  
`챗봇 엔진`은 챗봇에서 핵심 기능을 하는 `모듈`이며, 화자의 질문을 이해하고 알맞은 
답변을 출력하는 역할을 한다.  

한 마디로 `자연어 처리 모듈`이라고 한다.  

## 8.2 챗봇 엔진 구조
챗봇을 설계하기 전에 내가 만들고자 하는 챗봇의 목적과 어떤 도메인 지식을 가지는 
챗봇을 만들 것인지 결정해야 한다.  
그에 따라 챗봇 엔진 개발 방법론과 학습에 필요한 데이터셋이 달라지기 때문에 매우 중요한 과정이다!!  

이 책에서 만드는 챗봇은 토이 수준의 챗봇이며, 이 챗봇 엔진은 토이 수준이기 때문에 
크게 5가지의 기능을 한다.  

[기능]  

| 핵심 기능     | 설명                                                                  |
|-----------|---------------------------------------------------------------------|
| 질문 의도 분류  | 화자의 질문 의도를 파악함. 의도 분류 모델을 이용해 의도 클래스를 예측하는 문제.                      |
| 개체명 인식    | 화자의 질문에서 단어 토큰별 개체명을 인식함. 단어 토큰에 맞는 개체명을 예측하는 문제.                   |
| 핵심 키워드 추출 | 화자의 질문 의미에서 핵심이 될 만한 단어 토큰을 추출. 형태소 분석기를 이용해 핵심 키워드가 되는 명사나 동사를 추출. |
| 답변 검색     | 해당 질문의 의도, 개체명, 핵심 키워드 등을 기반으로 답변을 학습 DB에서 검색.                      |
| 소켓 서버     | 다양한 종류의 챗봇 클라이언트에서 요청하는 질문을 처리하기 위해 소켓 서버 프로그램 역할. (챗봇 엔진 서버 프로그램)  |

[챗봇 엔진 처리 과정]  
```commandline
[질문]  
"내일 오전 10시에 탕수육 주문하고 싶어" -> 챗봇 엔진  

[챗봇 엔진]  
1. 전처리 과정 - 불용어 제거, 토큰 분리(키워드 추출) ->  
2. 의도 분석 - 의도: 음식 주문 -> 
3. 개체명 인식 - 내일: Data, 오전 10시: Time, 탕수육: Food -> 
4. 답변 검색 - (의도, 개체명, 키워드) -> 
5. 학습 DB - DB에서 적절한 답변 탐색 -> 
6. 답변 출력 -> 출력

[답변]  
"주문해주셔서 감사합니다."
```  
화자의 질의 문장이 입력되면 챗봇 엔진은 제일 먼저 `전처리`를 진행한다.  
형태소 분석기를 이용해 단어 토큰(키워드)을 추출한 뒤 명사나 동사 등 필요한 품사만 남기고 불용어는 제거한다.  
여기서, `불용어(Stopword)`란 언어 분[석시 의미가 있는 단어와 의미가 없는 단어나 조사 등이 있는데, 그 중에서 의미가 없는 것을 `불용어`라고 한다.  
그 다음 의도 분석과 개체명 인식을 완료한 후 결과값을 이용해 적절한 답변을 학습 DB에서 검색해 화자에게 답변을 출력함.  
  
해당 챗봇 엔진에는 자연어 처리를 위해 2가지 딥러닝 모델(의도 분석, 개체명 인식)을 사용한다.  
해당 `도메인 지식`에 맞는 딥러닝 모델 학습 데이터셋을 많이 보유하고 있다면 `성능`이 우수한 챗봇 엔진 개발에 도움이 된다!  
`성능`은 클라이언트의 질문에 대한 답변의 속도, 질문에 얼마나 적절한 답변을 출력하는가 등... 이 있는 것 같습니다.  
  
## 8.3 전처리 과정
챗봇에서 자연어를 처리할 때 가장 먼저 수행해야 하는 기본 과정인 `전처리 과정`은 어떻게 될까?  
전처리를 어떻게 하느냐에 따라 후처리 부분의 성능 차이가 커지므로 매우 중요하다고 한다!  

이 책에서 만드는 챗봇 엔진 전처리 과정은 `1) 형태소 분석기로 토크나이징`하고, `2) 문장 해석에 의미 있는 정보만 남기고`, `3) 나머지 불용어들은 제거`하는 
작업을 한다.  

전처리 과정을 담당하는 모듈은 유틸리티 라이브러리이기 때문에 */utils* 내에 생성한다.  


## 8.4 단어 사전 구축 및 시퀀스 생성
챗봇 엔진에서 의도 분류 및 개체명 인식 모델의 학습을 하려면 단어 사전을 구축해야 한다.  
`corpus.txt`와 `create_dict.py`는 */train_tools/dict/* 에 생성한다.  

## 8.5 의도 분류 모델
챗봇 엔진에 화자의 질의가 입력되었을 때 전처리 과정을 거친 후 해당 문장의 의도를 분류한다.  
이 때 문장을 의도 클래스 별로 분류하기 위해 `CNN모델`을 사용함!  

[챗봇 엔진의 의도 분류 클래스 종류]  

| 의도명 | 분류 클래스 | 설명                 |
|-----|--------|--------------------|
| 인사  | 0      | 텍스트가 인사말인 경우       |
| 욕설  | 1      | 텍스트가 욕설인 경우        |
| 주문  | 2      | 텍스트가 주문 관련 내용인 경우  |
| 예약  | 3      | 텍스트가 예약 관련 내용인 경우  |
| 기타  | 4      | 어떤 의도에도 포함되지 않는 경우 |  

*/config* 안에 GlobalParams.py 파일을 생성함.  

### 8.5.1 의도 분류 모델 학습
*/models/intent* 디렉토리에 `total_train_data.csv` 파일을 학습 데이터셋으로 사용함.  
같은 위치에 `train_model.py`파일을 생성함.  

### 8.5.2 의도 분류 모듈 생성
챗봇 엔진의 의도 분류 모듈을 만들어보자.  
이 모듈은 의도 분류 모델 파일을 활용해 입력되는 텍스트의 의도 클래스를 예측하는 기능을 
가지고 있다.  

해당 모듈은 `딥러닝 모델`이므로 *models/intent* 내에 `IntentModel.py`파일을 생성한다.  
다음으로 IntentModel 클래스를 테스트하는 코드를 작성해야 한다.  
IntentModel 객체를 생성해 새로운 유형의 문장을 분류한다.  
테스트 코드이므로, */test* 아래에 `model_intent_test.py`파일을 생성한다.  

## 8.6 개체명 인식 모델 학습
챗봇 엔진에 입력된 문장의 의도가 분류된 후  문장 내 `개체명 인식(NER)`을 진행한다.  
개체명 인식을 위해 `양방향 LSTM`모델을 사용한다.  

[개체명 종류]  

|개체명| 설명     |
|---|--------|
|B_FOOD| 음식     |
|B_DT, B_TI| 날짜, 시간 |
|B_PS| 사람     |
|B_OG| 조직, 회사 |
|B_LC| 지역     |
  

### 8.6.1 개체명 인식 모델 학습
*/models/ner* 디렉토리의 `ner_train.txt`파일을 학습데이터 셋으로 사용한다.  
같은 경로에 `train_model.py`파일을 생성한다.  
이 파일은 `ner_train.txt`파일을 읽어와 `NER(개체명 인식) 모델`을 생성하고 학습하는 코드임.  

### 8.6.2 개체명 인식 모듈 생성
챗봇 엔진의 개체명 인식 모듈을 만들어보자.  
이 모듈은 `개체명 인식 모델` 파일을 활용해 입력한 문장 내부의 개체명을 인식한다.  
이 모듈은 `딥러닝 모델`이므로 */models/ner* 아래에 `NerModel.py`파일을 생성한다.  

## 8.7 답변 검색
화자로부터 입력된 문장이 전처리, 의도 분류, 개체명 인식 과정을 거쳐 해석된 데이터를 기반으로 
적절한 답변을 학습 DB로부터 검색하는 방법을 다룬다.  
챗봇 엔진이 자연어 차리를 통해 해석한 문장을 토대로 유사한 답변을 검색하는 일은 매우 중요하다.  

### 8.7.1 데이터베이스 제어 모듈 생성
*/utils* 아래에 `Database.py`파일을 생성한다.  


### 8.7.2 답변 검색 모듈 생성
챗봇 엔진은 입력되는 문장을 전처리, 의도 분류, 개체명 인식 과정을 거쳐서 나온 자연어 해석 결과를 이용해 
학습 DB에서 적절한 답변을 검색한다.  
*/utils* 아래에 `FindAnswer.py` 파일을 생성하자.  

## 8.8 챗봇 엔진 서버 개발
이 책에서 목표로 하는 챗봇 엔진은 다양한 플랫폼에서 언제든 접속해서 사용할 수 있도록 서버용 프로그램으로 제작하는 것이다.  
핵심 기능은 앞서 구현한 부분을 그대로 사용하며, 이 번에는 서버 통신을 위한 기능을 구현할 것임!  
  
챗봇들이 챗봇 엔진 서버와 `TCP/IP`방식으로 통신할 것임!  

### 8.8.1 통신 프로토콜 정의
최근에는 서버와 클라이언트 간의 통신을 `JSON 문자열`형태로 많이 한다고 한다.  
`JSON`은 `KEY:VALUE`의 형식으로 이루어진 데이터 객체를 전달하기 위해 인간이 읽을 수 있는 텍스트를 사용하는 
개방형 표준 포맷이다.  

### 8.8.2 다중 접속을 위한 TCP 소켓 서버
지금까지는 `싱글 스레드`의 방식이었다..  
싱글 스레드는 다수의 챗봇 클라이언트 서비스 요청을 한 번에 처리할 수 없다.  
이미 다른 클라이언트가 서비스를 받고 있으면 챗봇 엔진의 응답을 받지 못하기 때문...  

이럴 때 필요한 것이 바로 `멀티 스레드`방식이다.  
이 방식으로 챗봇 엔진 서버를 만들게 되면 다중 클라이언트가 서비스를 받을 수 있다!  

*/utils* 아래에 `BotServer.py`파일을 생성하자.  
*루트 디렉토리* 에는 클라이언트 파일인 `bot.py`파일을 생성한다.  


### 8.8.3 챗봇 테스트 클라이언트 프로그램
*/test* 아라에 `chatbot_client_test.py`파일을 생성한다.  